name: Unity Build Windows

on:
  workflow_dispatch:
    inputs:
      build_name:
        description: 'Build name'
        required: false
        default: 'ZenohUnityExample'

env:
  UNITY_VERSION: 2022.3.22f1
  PROJECT_PATH: samples/unity/ZenohUnityExample

jobs:
  check-license:
    name: Check License
    runs-on: ubuntu-latest
    outputs:
      has_license: ${{ steps.check.outputs.has_license }}
    steps:
      - name: Check if license exists
        id: check
        run: |
          if [ -z "${{ secrets.UNITY_LICENSE }}" ]; then
            echo "has_license=false" >> $GITHUB_OUTPUT
          else
            echo "has_license=true" >> $GITHUB_OUTPUT
          fi

  # Show instructions when license is not configured
  show-instructions:
    name: License Setup Instructions
    needs: check-license
    if: needs.check-license.outputs.has_license == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Show activation instructions
        run: |
          echo "::error::UNITY_LICENSE Secret is not configured"
          echo ""
          echo "=== Setup Instructions (Personal License for Windows IL2CPP) ==="
          echo ""
          echo "Required secrets: UNITY_LICENSE, UNITY_EMAIL, UNITY_PASSWORD"
          echo ""
          echo "--- Step 1: Add password to Unity ID (if using Google auth) ---"
          echo "1. Go to https://id.unity.com"
          echo "2. Navigate to Security section"
          echo "3. Click 'Add password' to set a password"
          echo ""
          echo "--- Step 2: Get your license file ---"
          echo "1. On your local machine, find your Unity license file:"
          echo "   - Windows: C:\\ProgramData\\Unity\\Unity_lic.ulf"
          echo "   - macOS: /Library/Application Support/Unity/Unity_lic.ulf"
          echo "   - Linux: ~/.local/share/unity3d/Unity/Unity_lic.ulf"
          echo ""
          echo "2. If you don't have a license file, activate Unity locally first:"
          echo "   - Open Unity Hub"
          echo "   - Sign in with your Unity account"
          echo "   - Activate a Personal license"
          echo ""
          echo "--- Step 3: Configure GitHub Secrets ---"
          echo "Go to GitHub repo: Settings > Secrets and variables > Actions"
          echo ""
          echo "Create these secrets:"
          echo "  - UNITY_LICENSE: Paste the entire .ulf file contents"
          echo "  - UNITY_EMAIL: Your Unity account email"
          echo "  - UNITY_PASSWORD: Your Unity account password"
          echo ""
          echo "--- Step 4: Re-run this workflow ---"
          echo ""
          echo "For more details: https://game.ci/docs/github/activation"
          exit 1

  # Build when license is configured
  build:
    name: Build for Windows (IL2CPP)
    needs: check-license
    if: needs.check-license.outputs.has_license == 'true'
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: ${{ env.PROJECT_PATH }}/Library
          key: Library-ZenohUnityExample-Windows-${{ hashFiles('samples/unity/ZenohUnityExample/Assets/**', 'samples/unity/ZenohUnityExample/Packages/**', 'samples/unity/ZenohUnityExample/ProjectSettings/**') }}
          restore-keys: |
            Library-ZenohUnityExample-Windows-
            Library-ZenohUnityExample-

      - name: Build Unity Project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          projectPath: ${{ env.PROJECT_PATH }}
          targetPlatform: StandaloneWindows64
          buildName: ${{ inputs.build_name || 'ZenohUnityExample' }}
          versioning: None

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ZenohUnityExample-Windows-${{ github.run_number }}
          path: build/StandaloneWindows64
          retention-days: 14
          if-no-files-found: error

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Log-${{ github.run_number }}
          path: ${{ env.PROJECT_PATH }}/Logs
          retention-days: 7
